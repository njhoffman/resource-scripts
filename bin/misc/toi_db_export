#!/bin/bash

PROD_HOST=jumponit.cyiwtm0qww1w.us-east-1.rds.amazonaws.com
PROD_USER=jump_sa
PROD_PASS=17U9Vj0744iN16U
PROD_DB=jumpOnIt

#staging creds
HOST=jumponit-stage.cyiwtm0qww1w.us-east-1.rds.amazonaws.com
USER=jump_sa
PASS=17U9Vj0744iN16U
DB=jumpOnIt_08_07_2017

SQL_DIR=/tmp/taponit-sql
ALL_TABLES=( analytics business businessCategory businessCategoryAssign campaign campaignCodeAssign campaignOfferAssign code contest contestEntry event eventAction eventRule market mmsSend mmsSendAttachment offerRedeem offerReferral offerShare offerTag offerTagAssign saveOffer smsOnlyOperator smsReceive smsSend subscriber subscriberHistory subscriberMarketAssign user userGroup )
PRIMARY_TABLES=( business businessCategory businessCategoryAssign contest contestEntry market offerRedeem offerReferral offerShare offerTag offerTagAssign subscriber subscriberHistory subscriberMarketAssign )

TABLES=("${PRIMARY_TABLES[@]}")

while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    --prod|--production)
      HOST=$PROD_HOST
      USER=$PROD_USER
      PASS=$PROD_PASS
      DB=$PROD_DB
      shift
      ;;
    --full|--all)
      TABLES=$ALL_TABLES
      shift
      ;;
    *)
      echo -e "Unknown option: $1\n"
    ;;
  esac
done

rm -rfv "$SQL_DIR/*"
for table in "${TABLES[@]}"; do
  echo -e "\n -- Exporting $table to $SQL_DIR/$table.out -- \n"
	sqsh -S $HOST -U $USER -P $PASS -D $DB -L bcp_colsep='|' -m bcp -C "SELECT * FROM $table" | tee "$SQL_DIR/$table.out"
done


# sqsh -S $HOST -U $USER -P $PASS -D $DB -L bcp_colsep='|' -m bcp -C "SELECT offerID, offerGUID, businessID, marketID, parentOfferID, name, image, shareImage, expirationDate, bonusOfferExpirationDate, maxReferralBonus, sharable, redeemable, isBonusOffer, active, deleted, created, lastUpdated FROM offer" | tee "$SQL_DIR/offer.out"
